###########################################################################
#  Copyright 2020 DataRobot Inc. All Rights Reserved.                     #
#                                                                         #
#  This file is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES       #
#  OR CONDITIONS OF ANY KIND, express or implied.                         #
###########################################################################
#
# TODO: View CloudFormation Logs in the Console
# https://aws.amazon.com/blogs/devops/view-cloudformation-logs-in-the-console/
# https://s3.amazonaws.com/cloudformation-templates-us-east-1/CloudWatch_Logs.template

AWSTemplateFormatVersion: "2010-09-09"
Description: DataRobot CloudFormation stack to create the EC2 instances for the cluster. (qs-????) 
Parameters:
  MainStack:
    Type: String
  S3Bucket:
    Type: String
    Description: CloudFormation repository S3 bucket name
  

Resources: 
  DataRobotIAMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Path: /

  InstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref DataRobotIAMRole

  RolePolicies:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: DataRobotIAMPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - 'ec2:DescribeInstances'
              - 'ec2:DescribeInstanceStatus'
              - 'ec2:DescribeImages'
              - 'ec2:CreateImage'
              - 'ec2:CreateSnapshot'
              - 'elasticloadbalancing:*'
              - 'lambda:CreateFunction'
              - 'lambda:DeleteFunction'
              - 'lambda:GetFunctionConfiguration'
              - 'ssm:DescribeParameters'
              - 'autoscaling:*'
              - 'cloudwatch:PutMetricData'
              - 'cloudwatch:GetMetricData'
              - 'cloudwatch:DescribeAlarmsForMetric'
              - 'cloudwatch:ListDashboards'
              - 'cloudwatch:GetMetricStatistics'
              - 'cloudwatch:GetMetricWidgetImage'
              - 'cloudwatch:ListMetrics'
            Resource:
              - '*'

          - Effect: Allow
            Action:
              - 'cloudwatch:*'
            Resource:
              - 'arn:aws:cloudwatch::*:dashboard/*'
              - 'arn:aws:cloudwatch::*:dashboard/*'

          - Effect: Allow
            Action:
              - 's3:ListAllMyBuckets'
              - 's3:Get*'
            Resource:
              - !Sub 'arn:aws:s3:::${S3Bucket}'
              - !Sub 'arn:aws:s3:::${S3Bucket}/*'
              - 'arn:aws:s3:::weswagner-quickstart-dr'
              - 'arn:aws:s3:::weswagner-quickstart-dr/*'

          - Effect: Allow
            Action:
              - 'cloudformation:DescribeStacks'
              - 's3:PutObject'
              - 's3:ListBucketMultipartUploads'
              - 's3:AbortMultipartUpload'
              - 's3:ListBucketVersions'
              - 's3:ListBucket'
              - 's3:DeleteObject'
              - 's3:GetBucketLocation'
              - 's3:ReplicateDelete'
              - 's3:ListMultipartUploadParts'
              - 'ssm:PutParameter'
              - 'ssm:GetParameter'
              - 'ssm:DeleteParameter'
            Resource:
              - arn:aws:ssm:*:*:parameter/*/datarobot-public-key
              - arn:aws:ssm:*:*:parameter/*/datarobot-ami-key
              - arn:aws:ssm:*:*:parameter/drami
              - !Sub 'arn:aws:s3:::${S3Bucket}'
              - !Sub 'arn:aws:s3:::${S3Bucket}/*'
              - !Sub 'arn:aws:cloudformation:*:*:stack/${MainStack}/*'

          - Effect: Allow
            Action:
              - 'ec2:CreateTags'
            Resource:
              - arn:aws:ec2:*:*:volume/*

      Roles:
        - !Ref DataRobotIAMRole      
Outputs:
  EC2InstanceSecurityProfile:
    Description: SecurityGroup settings when using an S3 Bucket
    Value: 
      Ref: InstanceProfile
    Export:
      Name: !Sub '${MainStack}-EC2InstanceSecurityProfile' 
  EC2InstanceSecurityProfileARN:
    Description: SecurityGroup settings when using an S3 Bucket
    Value: !GetAtt InstanceProfile.Arn
    Export:
      Name: !Sub '${MainStack}-EC2InstanceSecurityProfileARN'  